<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Auditor√≠a Av√≠cola ‚Äì Sistema Experto</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
body { background:#020617; color:#e5e7eb; font-family:system-ui; }
.section-header {
  background:linear-gradient(90deg,#1e3a8a,#020617);
  padding:.75rem 1rem;
  border-left:4px solid #60a5fa;
  margin-top:2rem;
  font-weight:800;
  text-transform:uppercase;
  font-size:.85rem;
}
.card {
  background:#0f172a;
  border:1px solid #334155;
  border-radius:.5rem;
  padding:1rem;
}
.radio {
  border:1px solid #475569;
  padding:.4rem;
  border-radius:.4rem;
  font-size:.7rem;
  text-align:center;
  cursor:pointer;
}
.radio input { display:none }
.radio input:checked + div {
  background:#2563eb;
  color:white;
  font-weight:bold;
}
</style>
</head>

<body class="pb-32">

<!-- HEADER -->
<div class="sticky top-0 z-50 bg-[#020617] border-b border-slate-800 px-6 py-4">
  <h1 class="text-xl font-bold text-blue-400">üß¨ Auditor√≠a Av√≠cola ‚Äì Sistema Experto</h1>
</div>

<!-- DATOS GENERALES -->
<div class="max-w-7xl mx-auto px-6 mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
  <input id="project_name" class="card" placeholder="Nombre del predio"/>
  <input id="project_price" type="number" class="card" placeholder="Precio venta CLP"/>
  <input id="project_ha" type="number" class="card" placeholder="Hect√°reas"/>
  <select id="project_owner" class="card">
    <option>Due√±o (Rol Propio)</option>
    <option>Sucesi√≥n</option>
    <option>Arriendo</option>
  </select>
</div>

<!-- CONTENIDO -->
<div id="main" class="max-w-7xl mx-auto px-6"></div>

<!-- FOOTER -->
<div class="fixed bottom-0 w-full bg-[#020617] border-t border-slate-800 p-4 flex justify-end">
  <button onclick="generarInforme()" class="bg-blue-600 px-6 py-2 rounded font-bold">
    ‚ö° Auditar y Valorizar
  </button>
</div>

<!-- MODAL -->
<div id="modal" class="hidden fixed inset-0 bg-black/90 z-50 p-6 overflow-y-auto">
  <div class="max-w-4xl mx-auto bg-[#020617] border border-slate-700 rounded p-6">
    <button onclick="cerrar()" class="mb-4 text-sm text-gray-400">‚Üê Volver</button>
    <div id="report"></div>
    <div class="mt-6 border-t border-slate-700 pt-4">
      <h3 class="text-sm font-bold text-gray-400">Opini√≥n cualitativa (IA)</h3>
      <div id="ai-text" class="italic text-gray-400 mt-2">Consultando IA‚Ä¶</div>
    </div>
  </div>
</div>

<script>
const protocol = [
  { cat:"Activos Biol√≥gicos", items:[
    {id:"aves_viejas",q:"Gallinas >60 semanas",type:"number"},
    {id:"edad_viejas",q:"Edad exacta viejas (sem)",type:"number"},
    {id:"aves_nuevas",q:"Gallinas <20 semanas",type:"number"},
    {id:"edad_nuevas",q:"Edad exacta nuevas (sem)",type:"number"},
    {id:"mortalidad",q:"Mortalidad diaria %",type:"number"},
  ]},
  { cat:"Legalidad", items:[
    {id:"rup",q:"RUP",type:"radio",opts:["No","En tr√°mite","Vigente"]},
    {id:"salud",q:"Resoluci√≥n sanitaria",type:"radio",opts:["Sin","Provisoria","Definitiva"]},
    {id:"agua",q:"DGA Agua",type:"radio",opts:["Pozo negro","En tr√°mite","Derechos OK"]},
  ]},
  { cat:"Costos", items:[
    {id:"personal",q:"N¬∞ trabajadores",type:"number"},
    {id:"sueldo",q:"Sueldo promedio CLP",type:"number"},
    {id:"luz",q:"Gasto luz mensual",type:"number"},
    {id:"agua_gasto",q:"Gasto agua mensual",type:"number"},
  ]}
];

let state = {};

function render(){
  const main=document.getElementById("main");
  let html="";
  protocol.forEach(sec=>{
    html+=`<div class="section-header">${sec.cat}</div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">`;
    sec.items.forEach(i=>{
      if(i.type==="number"){
        html+=`<div class="card">
          <label class="text-xs">${i.q}</label>
          <input type="number" class="w-full bg-transparent border-b" 
          onchange="state['${i.id}']=this.value"/>
        </div>`;
      } else {
        html+=`<div class="card"><div class="text-xs mb-2">${i.q}</div>
        <div class="grid grid-cols-3 gap-2">`;
        i.opts.forEach(o=>{
          html+=`<label class="radio">
            <input type="radio" name="${i.id}" onchange="state['${i.id}']='${o}'"/>
            <div>${o}</div>
          </label>`;
        });
        html+=`</div></div>`;
      }
    });
    html+=`</div>`;
  });
  main.innerHTML=html;
}

render();

function generarInforme(){
  document.getElementById("modal").classList.remove("hidden");

  const name=document.getElementById("project_name").value;
  const price=document.getElementById("project_price").value;

  let findings=Object.keys(state).slice(0,30)
    .map(k=>`- ${k}: ${state[k]}`).join("\n");

  document.getElementById("report").innerHTML=
  `<h2 class="text-xl font-bold text-blue-400">Auditor√≠a: ${name}</h2>
   <p class="text-sm text-gray-400">Precio: ${price} CLP</p>`;

  consultarIA(findings,name,price);
}

function cerrar(){
  document.getElementById("modal").classList.add("hidden");
}

async function consultarIA(findings,name,price){
  const ai=document.getElementById("ai-text");

  const prompt=`
Eres m√©dico veterinario experto en due diligence av√≠cola (Chile).
Predio: ${name}
Precio: ${price}
Hallazgos:
${findings}

Responde:
1. ¬øComprar√≠as? (S√≠/No)
2. Riesgos cr√≠ticos
3. Condici√≥n m√≠nima para negociar
`;

  try{
    const r=await fetch("/api/gemini",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ prompt })
    });
    const d=await r.json();
    const text=d?.candidates?.[0]?.content?.parts?.[0]?.text;
    ai.innerHTML=text?marked.parse(text):"IA sin respuesta √∫til.";
  } catch(e){
    ai.innerText="Error de conexi√≥n IA.";
  }
}
</script>

</body>
</html>
